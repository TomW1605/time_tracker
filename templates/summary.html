<!DOCTYPE html>
<html>
<head>
    <title>Summary</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='dark.css') }}">
    <style>
        h3, p {
            display: inline-block;
            margin: 0 5px 5px 0;
        }
        .week-row {
            background-color: #1e1e1e;
            cursor: pointer;
        }
        .session-row {
            display: none;
            background-color: #2c2c2c;
        }
        .session-header {
            background-color: #3c3c3c;
            font-weight: bold;
        }
        .expand-button {
            cursor: pointer;
            background: none;
            border: none;
            color: #1e90ff;
            font-size: 1em;
            font-family: 'Courier New', Courier, monospace; /* Monospace font */
            width: 1em; /* Ensure consistent width */
            display: inline-block; /* Ensure width is applied */
            text-align: center; /* Center the text */
            margin-right: 10px;
            margin-left: 0;
        }
        .delete-button {
            margin-left: 10px;
            color: red;
        }
    </style>
    <script>
        function compareDates(a, b) {
            return a > b ? -1 : a < b ? 1 : 0;
        }

        function compareSessions(a, b) {
            const a_date = (a.clock_in_time === null) ? a.date : a.clock_in_time;
            const b_date = (b.clock_in_time === null) ? b.date : b.clock_in_time;
            return compareDates(a_date, b_date);
        }

        function compareWeeks(a, b) {
            const a_date = new Date(a.split(' - ')[0]);
            const b_date = new Date(b.split(' - ')[0]);
            return compareDates(a_date, b_date);
        }

        function loadGroupedSessions() {
            fetch("{{ url_for('api_get_sessions_grouped') }}")
            .then(response => response.json())
            .then(data => {
                const tableBody = document.getElementById('groupedSessionsContainer');
                const weeks = Object.keys(data).sort(compareWeeks);
                let firstWeek = true;
                weeks.forEach(week => {
                    const sessions = data[week];
                    const totalHours = sessions.reduce((sum, session) => sum + session.hours_worked, 0);
                    if (totalHours > 0) {
                        const weekRow = document.createElement('tr');
                        weekRow.className = 'week-row';
                        weekRow.innerHTML = `
                            <td colspan="8" onclick="toggleSessions('${week}', this)">
                                <button class="expand-button">+</button> ${week} - ${totalHours.toFixed(1)} Hours
                            </td>
                        `;
                        tableBody.appendChild(weekRow);

                        const sessionHeader = document.createElement('tr');
                        sessionHeader.className = 'session-row session-header';
                        sessionHeader.innerHTML = `
                            <th>ID</th>
                            <th>Type</th>
                            <th>Date</th>
                            <th>Hours Worked</th>
                            <th>Clock In</th>
                            <th>Clock Out</th>
                            <th>Edit</th>
                        `;
                        sessionHeader.dataset.week = week;
                        tableBody.appendChild(sessionHeader);

                        sessions.sort(compareSessions).forEach(session => {
                            const sessionRow = document.createElement('tr');
                            sessionRow.className = 'session-row';
                            sessionRow.dataset.week = week;

                            const idCell = document.createElement('td');
                            idCell.textContent = session.id;
                            sessionRow.appendChild(idCell);

                            const typeCell = document.createElement('td');
                            typeCell.textContent = session.session_type;
                            sessionRow.appendChild(typeCell);

                            const dateCell = document.createElement('td');
                            dateCell.textContent = session.date;
                            sessionRow.appendChild(dateCell);

                            const hoursWorkedCell = document.createElement('td');
                            hoursWorkedCell.textContent = session.hours_worked;
                            sessionRow.appendChild(hoursWorkedCell);

                            const clockInCell = document.createElement('td');
                            clockInCell.textContent = session.clock_in_time;
                            sessionRow.appendChild(clockInCell);

                            const clockOutCell = document.createElement('td');
                            clockOutCell.textContent = session.clock_out_time;
                            sessionRow.appendChild(clockOutCell);

                            const editCell = document.createElement('td');
                            const editLink = document.createElement('a');
                            editLink.href = "{{ url_for('edit', id=0) }}" + session.id;
                            editLink.textContent = 'Edit';
                            editCell.appendChild(editLink);

                            const deleteButton = document.createElement('button');
                            deleteButton.textContent = 'Delete';
                            deleteButton.onclick = function() {
                                deleteSession(session.id);
                            };
                            deleteButton.className = 'delete-button';
                            editCell.appendChild(deleteButton);

                            sessionRow.appendChild(editCell);

                            tableBody.appendChild(sessionRow);
                        });

                        if (firstWeek) {
                            toggleSessions(week, weekRow);
                            firstWeek = false;
                        }
                    }
                });
            })
            .catch(error => console.error('Error:', error));
        }

        function toggleSessions(week, row) {
            const sessionRows = document.querySelectorAll(`.session-row[data-week="${week}"]`);
            sessionRows.forEach(row => {
                row.style.display = (row.style.display === 'none' || row.style.display === '') ? 'table-row' : 'none';
            });
            toggleButton(row.querySelector('.expand-button'));
        }

        function toggleButton(button) {
            button.textContent = button.textContent === '+' ? '-' : '+';
        }

        function loadHours() {
            fetch("{{ url_for('api_get_hours') }}")
            .then(response => response.json())
            .then(data => {
                const hours_el = document.getElementById('hours');
                console.log(data);

                const today_heading = document.createElement('h3');
                today_heading.textContent = "Hours worked today:";
                hours_el.appendChild(today_heading);

                const today_hours = document.createElement('p');
                today_hours.textContent = data.hours_today;
                hours_el.appendChild(today_hours);

                hours_el.appendChild(document.createElement('br'));

                const week_heading = document.createElement('h3');
                week_heading.textContent = "Hours worked this week:";
                hours_el.appendChild(week_heading);

                const week_hours = document.createElement('p');
                week_hours.textContent = data.hours_this_week;
                hours_el.appendChild(week_hours);
            })
            .catch(error => console.error('Error:', error));
        }

        function deleteSession(id) {
            if (confirm('Are you sure you want to delete this session?')) {
                fetch("{{ url_for('api_delete_session', id=0) }}" + id, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    location.reload();
                })
                .catch(error => console.error('Error:', error));
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadGroupedSessions();
            loadHours();
        });
    </script>
</head>
<body>
    <h1>Summary</h1>
    <div id="hours"></div>
    <p><a href="{{ url_for('index') }}">Home</a></p>
    <table class="week-table">
        <tbody id="groupedSessionsContainer">
            <!-- Grouped sessions will be loaded here by JavaScript -->
        </tbody>
    </table>
</body>
</html>
